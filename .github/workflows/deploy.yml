name: Deploy n8n to VPS

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸš€ Deploy to production server
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT }}
        script: |
          set -e
          
          echo "================================================"
          echo "ğŸš€ Starting deployment of n8n"
          echo "================================================"
          
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“¦ Git status before pull:"
          cd /opt/n8n
          git status
          
          echo ""
          echo "ğŸ“¥ Pulling latest changes from GitHub..."
          git fetch origin
          git reset --hard origin/main
          
          echo ""
          echo "ğŸ”¨ Building and restarting Docker containers..."
          docker compose -f docker-compose.production.yml down
          docker compose -f docker-compose.production.yml pull
          docker compose -f docker-compose.production.yml up -d --build
          
          echo ""
          echo "â³ Waiting for n8n to be ready (30 seconds)..."
          sleep 30
          
          echo ""
          echo "âœ… Checking n8n health..."
          if curl -f http://localhost:5678/healthz > /dev/null 2>&1; then
            echo "âœ… n8n is healthy!"
          else
            echo "âš ï¸  Health check failed, checking logs..."
            docker compose -f docker-compose.production.yml logs --tail=50 n8n
            exit 1
          fi
          
          echo ""
          echo "ğŸ“Š Container status:"
          docker compose -f docker-compose.production.yml ps
          
          echo ""
          echo "================================================"
          echo "ğŸ‰ Deployment completed successfully!"
          echo "================================================"
    
    - name: ğŸ“¢ Notify on success
      if: success()
      run: |
        echo "âœ… Deployment successful!"
        echo "ğŸ“… Time: $(date)"
        echo "ğŸ“ Commit: ${{ github.sha }}"
    
    - name: ğŸ“¢ Notify on failure
      if: failure()
      run: |
        echo "âŒ Deployment failed!"
        echo "ğŸ“… Time: $(date)"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        exit 1

